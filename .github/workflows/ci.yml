name: CI - Validate Pipelines

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate-pipelines:
    name: Validate Expanso Pipelines
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Expanso CLI locally
        run: |
          mkdir -p .bin
          curl -fsSL https://get.expanso.io/cli/install.sh | EXPANSO_INSTALL_DIR=.bin bash
          echo "$PWD/.bin" >> "$GITHUB_PATH"

      - name: Verify CLI installation
        run: .bin/expanso-cli help

      - name: Validate expanso-pipeline-FOR-EXPANSO-CLI.yaml
        run: .bin/expanso-cli job validate expanso-pipeline-FOR-EXPANSO-CLI.yaml --offline

  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d relaxed expanso-pipeline-FOR-EXPANSO-CLI.yaml
          yamllint -d relaxed observability-deployment.yaml
          yamllint -d relaxed expanso-edge-deployment.yaml
